<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TCLMarket2 ‚Äî Architecture Diagram (Updated)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', sans-serif;
      background: #0f1117;
      color: #e2e8f0;
      min-height: 100vh;
      padding: 32px 24px 60px;
    }

    /* ‚îÄ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ */
    .page-header {
      text-align: center;
      margin-bottom: 40px;
    }
    .page-header h1 {
      font-size: 2rem;
      font-weight: 800;
      background: linear-gradient(135deg, #f59e0b, #ef4444, #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
    }
    .page-header p {
      color: #64748b;
      font-size: 0.95rem;
    }
    .badge {
      display: inline-block;
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 20px;
      padding: 4px 14px;
      font-size: 0.78rem;
      color: #94a3b8;
      margin-top: 8px;
    }

    /* ‚îÄ‚îÄ‚îÄ Main Grid ‚îÄ‚îÄ‚îÄ */
    .diagram {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 20px;
      max-width: 1300px;
      margin: 0 auto 40px;
    }

    /* ‚îÄ‚îÄ‚îÄ Column ‚îÄ‚îÄ‚îÄ */
    .col {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .col-header {
      border-radius: 12px 12px 0 0;
      padding: 14px 18px;
      font-weight: 700;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 10px;
      text-shadow: 0 1px 3px rgba(0,0,0,.4);
    }
    .col-header.blue   { background: linear-gradient(135deg, #1d4ed8, #3b82f6); }
    .col-header.orange { background: linear-gradient(135deg, #b45309, #f59e0b); }
    .col-header.green  { background: linear-gradient(135deg, #065f46, #10b981); }

    /* ‚îÄ‚îÄ‚îÄ Box ‚îÄ‚îÄ‚îÄ */
    .box {
      border-radius: 12px;
      padding: 16px 18px;
      border: 1px solid;
      transition: transform .2s, box-shadow .2s;
      cursor: default;
    }
    .box:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(0,0,0,.45);
    }
    .box.blue   { background: #1e3a8a22; border-color: #3b82f655; }
    .box.orange { background: #92400e33; border-color: #f59e0b66; }
    .box.dark   { background: #1e293b;   border-color: #334155; }
    .box.purple { background: #4c1d9533; border-color: #8b5cf655; }
    .box.red    { background: #7f1d1d33; border-color: #ef444455; }
    .box.green  { background: #064e3b33; border-color: #10b98155; }
    .box.ws     { background: linear-gradient(135deg,#052e16,#064e3b); border-color: #10b981; }
    .box.live   { background: #0c1a2e; border-color: #3b82f655; }

    .box-title {
      font-weight: 700;
      font-size: 0.88rem;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .box-title .icon { font-size: 1.1rem; }

    .box ul { list-style: none; padding: 0; }
    .box ul li {
      padding: 4px 0 4px 14px;
      position: relative;
      font-size: 0.82rem;
      color: #cbd5e1;
      line-height: 1.5;
    }
    .box ul li::before {
      content: '‚ñ∏';
      position: absolute;
      left: 0;
      color: #64748b;
    }

    .chip {
      display: inline-block;
      border-radius: 6px;
      padding: 2px 8px;
      font-size: 0.7rem;
      font-weight: 600;
      margin: 2px 2px 0 0;
    }
    .chip.open       { background:#065f46; color:#6ee7b7; }
    .chip.closed     { background:#78350f; color:#fcd34d; }
    .chip.resolved   { background:#1d4ed8; color:#93c5fd; }
    .chip.cancelled  { background:#7f1d1d; color:#fca5a5; }
    .chip.pending    { background:#1e3a8a; color:#bfdbfe; }
    .chip.won        { background:#064e3b; color:#6ee7b7; }
    .chip.lost       { background:#450a0a; color:#fca5a5; }
    .chip.refunded   { background:#4a1d96; color:#ddd6fe; }

    /* ‚îÄ‚îÄ‚îÄ Formula Box ‚îÄ‚îÄ‚îÄ */
    .formula {
      background: #0f172a;
      border: 1px solid #1e3a8a44;
      border-radius: 8px;
      padding: 10px 14px;
      margin-top: 8px;
      font-family: 'Fira Code', monospace;
      font-size: 0.78rem;
      color: #a5b4fc;
      line-height: 1.7;
    }
    .formula .comment { color: #475569; }

    /* ‚îÄ‚îÄ‚îÄ DB Cylinders ‚îÄ‚îÄ‚îÄ */
    .db-item {
      background: #0d2b1d;
      border: 1px solid #10b98144;
      border-radius: 10px;
      padding: 12px 16px;
      position: relative;
      transition: transform .2s;
    }
    .db-item:hover { transform: translateX(4px); }
    .db-item::before {
      content: 'üóÑ';
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.2rem;
      opacity: .5;
    }
    .db-item .db-name {
      font-weight: 700;
      font-size: 0.88rem;
      color: #34d399;
      margin-bottom: 6px;
    }
    .db-item .db-fields {
      font-family: 'Fira Code', monospace;
      font-size: 0.72rem;
      color: #64748b;
      line-height: 1.6;
    }

    /* ‚îÄ‚îÄ‚îÄ Arrows row ‚îÄ‚îÄ‚îÄ */
    .arrows-row {
      max-width: 1300px;
      margin: 0 auto 40px;
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 20px;
      text-align: center;
    }
    .arrow-box {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 10px;
      padding: 12px 16px;
      font-size: 0.82rem;
    }
    .arrow-box .arrow-label { color: #f59e0b; font-weight: 700; margin-bottom: 4px; }
    .arrow-box .arrow-desc  { color: #64748b; font-size: 0.75rem; }

    /* ‚îÄ‚îÄ‚îÄ Lifecycle / State Machine ‚îÄ‚îÄ‚îÄ */
    .lifecycle {
      max-width: 1300px;
      margin: 0 auto 40px;
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 16px;
      padding: 24px 28px;
    }
    .lifecycle h2 {
      font-size: 1rem;
      font-weight: 700;
      color: #f59e0b;
      margin-bottom: 20px;
    }
    .states {
      display: flex;
      align-items: center;
      gap: 0;
      flex-wrap: wrap;
    }
    .state-node {
      background: #0f172a;
      border: 2px solid;
      border-radius: 10px;
      padding: 10px 18px;
      font-weight: 700;
      font-size: 0.85rem;
      text-align: center;
      min-width: 120px;
    }
    .state-node.open       { border-color: #10b981; color: #6ee7b7; }
    .state-node.closed     { border-color: #f59e0b; color: #fcd34d; }
    .state-node.resolved   { border-color: #3b82f6; color: #93c5fd; }
    .state-node.cancelled  { border-color: #ef4444; color: #fca5a5; }

    .state-arrow {
      padding: 0 10px;
      color: #475569;
      font-size: 1.2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 0.7rem;
      gap: 2px;
    }
    .state-arrow .arr { font-size: 1.4rem; color: #64748b; }

    .state-fork {
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: flex-start;
    }
    .state-fork-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .fork-label {
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 4px 10px;
      font-size: 0.72rem;
      color: #64748b;
    }

    /* ‚îÄ‚îÄ‚îÄ Concurrency Section ‚îÄ‚îÄ‚îÄ */
    .concurrency {
      max-width: 1300px;
      margin: 0 auto 40px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .code-block {
      background: #0d1117;
      border: 1px solid #21262d;
      border-radius: 12px;
      padding: 18px;
      font-family: 'Fira Code', monospace;
      font-size: 0.78rem;
      line-height: 1.8;
    }
    .code-block h3 {
      font-family: 'Inter', sans-serif;
      font-size: 0.85rem;
      font-weight: 700;
      color: #f59e0b;
      margin-bottom: 12px;
    }
    .code-keyword  { color: #ff7b72; }
    .code-fn       { color: #d2a8ff; }
    .code-string   { color: #a5d6ff; }
    .code-comment  { color: #8b949e; font-style: italic; }
    .code-var      { color: #e6edf3; }
    .code-num      { color: #79c0ff; }

    /* ‚îÄ‚îÄ‚îÄ Footer ‚îÄ‚îÄ‚îÄ */
    footer {
      text-align: center;
      color: #475569;
      font-size: 0.8rem;
      margin-top: 20px;
    }
    footer a { color: #3b82f6; text-decoration: none; }
  </style>
</head>
<body>

<div class="page-header">
  <h1>‚ö° TCLMarket2 ‚Äî Architecture Diagram</h1>
  <p>Prediction Market App inspired by Polymarket ‚Äî ‡∏â‡∏ö‡∏±‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏•‡πâ‡∏ß</p>
  <span class="badge">Updated: 20 Feb 2026 ¬∑ MERN Stack ¬∑ WebSocket ¬∑ AMM Odds</span>
</div>

<!-- ‚ïê‚ïê‚ïê MAIN DIAGRAM ‚ïê‚ïê‚ïê -->
<div class="diagram">

  <!-- ‚îÄ‚îÄ COLUMN 1: Frontend ‚îÄ‚îÄ -->
  <div class="col">
    <div class="col-header blue">‚öõÔ∏è Frontend (React + Vite)</div>

    <div class="box blue">
      <div class="box-title"><span class="icon">üîê</span>Login / Register</div>
      <ul>
        <li>JWT Access Token + Refresh Token</li>
        <li>Role-based: <strong>user</strong> | <strong>admin</strong></li>
        <li>Remember Me (Refresh Token)</li>
      </ul>
    </div>

    <div class="box blue">
      <div class="box-title"><span class="icon">üìä</span>Dashboard (Market List)</div>
      <ul>
        <li>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ & ‡∏Å‡∏£‡∏≠‡∏á Markets</li>
        <li>Odds Preview Card</li>
        <li>Status Badge: Open / Closed / Resolved</li>
      </ul>
    </div>

    <div class="box blue">
      <div class="box-title"><span class="icon">üìà</span>Market Detail (Place Bet)</div>
      <ul>
        <li>Odds Bar Chart (Yes vs No)</li>
        <li>Bet Form: Choose Side + Enter Stake</li>
        <li>Payout Preview (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Real-time)</li>
        <li><strong>Live Update</strong> ‡∏ú‡πà‡∏≤‡∏ô WebSocket</li>
      </ul>
    </div>

    <div class="box blue">
      <div class="box-title"><span class="icon">üìã</span>My Bets (History)</div>
      <ul>
        <li>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Bet ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</li>
        <li>Status: <span class="chip pending">pending</span><span class="chip won">won</span><span class="chip lost">lost</span><span class="chip refunded">refunded</span></li>
        <li>Transaction Log (‡∏ù‡∏≤‡∏Å/‡∏ñ‡∏≠‡∏ô/‡∏ä‡∏ô‡∏∞/Refund)</li>
      </ul>
    </div>

    <div class="box" style="background:#431407aa;border-color:#ea580c88;">
      <div class="box-title"><span class="icon">üõ°Ô∏è</span>Admin Panel (Protected Route)</div>
      <ul>
        <li>‡∏™‡∏£‡πâ‡∏≤‡∏á / ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Markets</li>
        <li>‡∏õ‡∏¥‡∏î Market / ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ú‡∏• / ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</li>
        <li>‡∏î‡∏π Users & Balance</li>
      </ul>
    </div>

    <div class="box ws">
      <div class="box-title"><span class="icon">‚ö°</span>Socket.io Client</div>
      <ul>
        <li>Join Market Room ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ Market</li>
        <li>‡∏£‡∏±‡∏ö <code>odds:update</code> ‚Üí ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Chart</li>
        <li>‡∏£‡∏±‡∏ö <code>market:resolved</code> ‚Üí ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô üîî</li>
        <li>‡∏£‡∏±‡∏ö <code>balance:update</code> ‚Üí ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Balance</li>
      </ul>
    </div>

    <div class="box live">
      <div class="box-title"><span class="icon">üì°</span>Live Display</div>
      <div class="formula">
Yes Odds:  <span style="color:#6ee7b7">65%</span>  (0.65)<br/>
No  Odds:  <span style="color:#fca5a5">35%</span>  (0.35)<br/>
Stake 100 ‚Üí Payout: <span style="color:#fcd34d">153.85</span> units<br/>
üîî Result Notification
      </div>
    </div>

  </div>

  <!-- ‚îÄ‚îÄ COLUMN 2: Backend ‚îÄ‚îÄ -->
  <div class="col">
    <div class="col-header orange">üü† Backend (Node.js + Express)</div>

    <div class="box dark">
      <div class="box-title"><span class="icon">üîë</span>JWT Auth Middleware</div>
      <ul>
        <li>Verify Access Token ‡∏ó‡∏∏‡∏Å Request</li>
        <li>Role Guard: <code>requireUser</code> / <code>requireAdmin</code></li>
        <li>Refresh Token Rotation</li>
        <li>Token Blacklist (Logout)</li>
      </ul>
    </div>

    <div class="box orange">
      <div class="box-title"><span class="icon">üí∞</span>Bet Placement (MongoDB Transaction)</div>
      <ul>
        <li>1. ‡∏ï‡∏£‡∏ß‡∏à Market status === <code>'open'</code></li>
        <li>2. Atomic balance deduct (Concurrency-safe)</li>
        <li>3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Bet record</li>
        <li>4. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï totalYes / totalNo / totalPool</li>
        <li>5. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Transaction log</li>
        <li>6. Commit ‚Üí Broadcast Odds via Socket</li>
      </ul>
    </div>

    <div class="box dark">
      <div class="box-title"><span class="icon">üìê</span>AMM Odds Engine</div>
      <div class="formula">
<span class="comment">// Automated Market Maker</span><br/>
priceYes = totalYes / totalPool<br/>
priceNo  = totalNo  / totalPool<br/>
<br/>
<span class="comment">// Payout (‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà Bet)</span><br/>
payout = stake / priceAtBet<br/>
<br/>
<span class="comment">// ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: 100 / 0.65 = 153.85</span>
      </div>
    </div>

    <div class="box purple">
      <div class="box-title"><span class="icon">üë§</span>Admin Controls</div>
      <ul>
        <li>POST /markets ‚Äî ‡∏™‡∏£‡πâ‡∏≤‡∏á Market ‡πÉ‡∏´‡∏°‡πà</li>
        <li>PATCH /close ‚Äî ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö Bet</li>
        <li>PATCH /resolve ‚Äî ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ú‡∏• Yes/No ‚Üí ‡πÅ‡∏à‡∏Å Winnings (Atomic)</li>
        <li>PATCH /cancel ‚Äî ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å ‚Üí Refund ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</li>
        <li>Broadcast Result ‡∏ú‡πà‡∏≤‡∏ô Socket.io</li>
      </ul>
    </div>

    <div class="box red">
      <div class="box-title"><span class="icon">‚ö†Ô∏è</span>Error Handling</div>
      <ul>
        <li><strong>INSUFFICIENT_BALANCE</strong> ‚Üí 400 Bad Request</li>
        <li><strong>MARKET_NOT_OPEN</strong> ‚Üí 400 Bad Request</li>
        <li><strong>Race Condition</strong> ‚Üí <code>findOneAndUpdate</code> atomic</li>
        <li><strong>JWT Expired</strong> ‚Üí 401 ‚Üí Frontend refresh</li>
        <li><strong>Socket Disconnect</strong> ‚Üí Auto Reconnect</li>
        <li><strong>Cancel Market</strong> ‚Üí Auto Refund All</li>
      </ul>
    </div>

    <div class="box dark">
      <div class="box-title"><span class="icon">üîå</span>Socket.io Server</div>
      <ul>
        <li><code>join:market</code> ‚Üí Join Room</li>
        <li>Emit <code>odds:update</code> ‚Üí Room Members</li>
        <li>Emit <code>market:resolved</code> ‚Üí All in Room</li>
        <li>Emit <code>balance:update</code> ‚Üí User Socket</li>
      </ul>
    </div>

  </div>

  <!-- ‚îÄ‚îÄ COLUMN 3: Database ‚îÄ‚îÄ -->
  <div class="col">
    <div class="col-header green">üóÑÔ∏è Database (MongoDB)</div>

    <div class="db-item">
      <div class="db-name">üë• users</div>
      <div class="db-fields">
        _id, username, email<br/>
        passwordHash, balance<br/>
        role: <span style="color:#6ee7b7">"user"</span> | <span style="color:#fcd34d">"admin"</span><br/>
        createdAt, updatedAt
      </div>
    </div>

    <div class="db-item">
      <div class="db-name">üè™ markets</div>
      <div class="db-fields">
        _id, title, description, category<br/>
        totalYes, totalNo, totalPool<br/>
        status: <span class="chip open">open</span><span class="chip closed">closed</span><span class="chip resolved">resolved</span><span class="chip cancelled">cancelled</span><br/>
        result: "yes" | "no" | null<br/>
        closingDate, resolvedAt, createdBy
      </div>
    </div>

    <div class="db-item">
      <div class="db-name">üéØ bets</div>
      <div class="db-fields">
        _id, userId (ref), marketId (ref)<br/>
        side: "yes" | "no"<br/>
        stake, priceAtBet<br/>
        potentialPayout, actualPayout<br/>
        status: <span class="chip pending">pending</span><span class="chip won">won</span><span class="chip lost">lost</span><span class="chip refunded">refunded</span>
      </div>
    </div>

    <div class="db-item">
      <div class="db-name">üí≥ transactions</div>
      <div class="db-fields">
        _id, userId (ref)<br/>
        type: "bet" | "win" | "refund" | "deposit"<br/>
        amount, balanceBefore, balanceAfter<br/>
        referenceId (betId | marketId)<br/>
        description, createdAt
      </div>
    </div>

    <div class="db-item">
      <div class="db-name">üîí sessions</div>
      <div class="db-fields">
        _id, jti (JWT ID)<br/>
        userId (ref), reason<br/>
        expiresAt (TTL Index)<br/>
        <span style="color:#8b949e">‚Üê JWT Blacklist for Logout</span>
      </div>
    </div>

    <div class="box green" style="margin-top:4px;">
      <div class="box-title"><span class="icon">‚ö°</span>Atomic Operations</div>
      <ul>
        <li>MongoDB Sessions (Multi-doc Transactions)</li>
        <li><code>findOneAndUpdate</code> ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Race Condition</li>
        <li>TTL Index ‡∏ö‡∏ô sessions collection</li>
      </ul>
    </div>
  </div>

</div>

<!-- ‚ïê‚ïê‚ïê DATA FLOW ARROWS ‚ïê‚ïê‚ïê -->
<div class="arrows-row">
  <div class="arrow-box">
    <div class="arrow-label">‚üµ REST API + JWT Header ‚ü∂</div>
    <div class="arrow-desc">Frontend ‚Üî Backend via HTTP<br/>Authorization: Bearer &lt;token&gt;</div>
  </div>
  <div class="arrow-box">
    <div class="arrow-label">‚ö° WebSocket (Socket.io) ‚ö°</div>
    <div class="arrow-desc">Bidirectional Real-time<br/>odds:update ¬∑ market:resolved ¬∑ balance:update</div>
  </div>
  <div class="arrow-box">
    <div class="arrow-label">‚ü∂ Mongoose ODM ‚ü∂</div>
    <div class="arrow-desc">Backend ‚Üí MongoDB<br/>Atomic Transactions ¬∑ Session Support</div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê LIFECYCLE STATE MACHINE ‚ïê‚ïê‚ïê -->
<div class="lifecycle">
  <h2>üîÑ Market Lifecycle (State Machine)</h2>
  <div class="states">
    <div class="state-node open">üü¢ OPEN<br/><small>‡∏£‡∏±‡∏ö Bet ‡πÑ‡∏î‡πâ</small></div>
    <div class="state-arrow"><span class="arr">‚Üí</span><span>Admin ‡∏õ‡∏¥‡∏î</span></div>
    <div class="state-node closed">üü° CLOSED<br/><small>‡∏´‡∏¢‡∏∏‡∏î‡∏£‡∏±‡∏ö Bet</small></div>
    <div class="state-arrow"><span class="arr">‚Üí</span><span>Admin ‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô</span></div>
    <div class="state-fork">
      <div class="state-fork-item">
        <div class="state-node resolved">üîµ RESOLVED<br/><small>‡πÅ‡∏à‡∏Å Winnings</small></div>
        <div class="fork-label">Yes/No ‡∏ä‡∏ô‡∏∞ ‚Üí actualPayout = stake / priceAtBet</div>
      </div>
      <div class="state-fork-item">
        <div class="state-node cancelled">üî¥ CANCELLED<br/><small>Refund ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</small></div>
        <div class="fork-label">‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÑ‡∏î‡πâ stake ‡∏Ñ‡∏∑‡∏ô 100%</div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê CONCURRENCY FIX ‚ïê‚ïê‚ïê -->
<div class="concurrency">
  <div class="code-block">
    <h3>‚ùå ‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏Å‡πà‡∏≤ (‡∏°‡∏µ Race Condition)</h3>
    <span class="code-comment">// ‚ùå ‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢! ‡∏ñ‡πâ‡∏≤ 2 Request ‡∏°‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô</span><br/>
    <span class="code-keyword">const</span> <span class="code-var">user</span> = <span class="code-keyword">await</span> User.<span class="code-fn">findById</span>(userId);<br/>
    <span class="code-keyword">if</span> (user.balance &lt; stake) <span class="code-keyword">throw</span> error;<br/>
    user.balance -= stake; <span class="code-comment">// ‚Üê ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πà‡∏≤!</span><br/>
    <span class="code-keyword">await</span> user.<span class="code-fn">save</span>(); <span class="code-comment">// ‚Üê ‡∏≠‡∏≤‡∏à overwrite ‡∏Å‡∏±‡∏ô</span>
  </div>
  <div class="code-block">
    <h3>‚úÖ ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏´‡∏°‡πà (Atomic ‚Äî ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ 100%)</h3>
    <span class="code-comment">// ‚úÖ findOneAndUpdate atomic</span><br/>
    <span class="code-keyword">const</span> <span class="code-var">updated</span> = <span class="code-keyword">await</span> User.<span class="code-fn">findOneAndUpdate</span>(<br/>
    &nbsp;&nbsp;{ _id: userId, balance: { <span class="code-string">$gte</span>: stake } },<br/>
    &nbsp;&nbsp;{ <span class="code-string">$inc</span>: { balance: -stake } },<br/>
    &nbsp;&nbsp;{ session, <span class="code-string">new</span>: <span class="code-keyword">true</span> }<br/>
    );<br/>
    <span class="code-keyword">if</span> (!updated) <span class="code-keyword">throw new</span> <span class="code-fn">Error</span>(<span class="code-string">'INSUFFICIENT_BALANCE'</span>);
  </div>
</div>

<footer>
  TCLMarket2 Architecture v2.0 ¬∑ Inspired by <a href="https://polymarket.com" target="_blank">Polymarket</a> ¬∑ Updated 20 Feb 2026
</footer>

</body>
</html>
